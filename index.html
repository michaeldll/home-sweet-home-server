<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Home sweet Home - Websockets Server</title>
		<style>
			.hide {
				display: none;
			}
			p.small {
				font-size: 0.8rem;
			}
			p.bold {
				font-weight: bold;
			}
			.dialog {
				width: 50px;
			}
			.dialog .content {
				display: none;
				width: 90vw;
			}
			.dialog:hover .content {
				display: block;
			}
		</style>
	</head>

	<body>
		<h2 class="time bold">Client time :</h2>

		<div id="client-time" class="time">waiting for javascript</div>

		<h2 class="time bold" class="time">Server time :</h2>

		<div id="server-time" class="time">waiting for connection</div>

		<h2 class="bold">Device Alpha:</h2>

		<div id="device-alpha">waiting for device event</div>

		<h2 class="bold">
			<span>Device Beta:</span>
			<span class="dialog">
				<button>?</button>
				<div class="content">
					<p class="small">
						Represents the front to back motion of the device, around the x axis. <br />
						In degrees with values ranging from -180 to 180. <br />
					</p>

					<p class="small bold">
						Only works on devices emitting the "deviceorientation" event, like smartphones.
					</p>
				</div>
			</span>
		</h2>

		<div id="device-beta">waiting for device event</div>

		<h2 class="bold">Device Gamma:</h2>

		<div id="device-gamma">waiting for device event</div>

		<h2>Server Alpha:</h2>

		<div id="server-alpha">waiting for connection</div>

		<h2>Server Beta:</h2>

		<div id="server-beta">waiting for connection</div>

		<h2>Server Gamma:</h2>

		<div id="server-gamma">waiting for connection</div>

		<script>
			const HOST = location.origin.replace(/^http/, 'ws')
			const WEBSOCKET = new WebSocket(HOST)
			const DEBUG_TIME = false

			let alphaValue = 0
			let betaValue = 0
			let gammaValue = 0
			let connected = false

			const getClientTime = now => {
				const hours = now.getHours()
				const minutes = now.getMinutes()
				const seconds = now.getSeconds()
				const milliseconds = now.getMilliseconds()

				const dateString = `${hours}:${minutes}:${seconds}:${milliseconds}`

				return dateString
			}

			const setNode = (origin, value) => {
				let node

				switch (origin) {
					case 'time-client':
						node = document.querySelector('#client-time')
						break

					case 'time-server':
						node = document.querySelector('#server-time')
						break

					case 'beta-client':
						node = document.querySelector('#device-beta')
						break

					case 'beta-server':
						node = document.querySelector('#server-beta')
						break

					case 'alpha-client':
						node = document.querySelector('#device-alpha')
						break

					case 'alpha-server':
						node = document.querySelector('#server-alpha')
						break

					case 'gamma-client':
						node = document.querySelector('#device-gamma')
						break

					case 'gamma-server':
						node = document.querySelector('#server-gamma')
						break

					default:
						break
				}

				if (node) node.innerText = value
			}

			const sendToServer = (type, value) => {
				const message = { type: type, message: JSON.stringify(value) }
				const string = JSON.stringify(message)
				WEBSOCKET.send(string)
			}

			const handleOrientation = event => {
				/*
					Alpha: represents the motion of the device around the z axis.
					Represented in degrees with values ranging from 0 to 360.
				*/

				alphaValue = event.alpha

				/*
					Beta: represents the motion of the device around the x axis.
					Represented in degrees with values ranging from -180 to 180.
					This represents a front to back motion of the device.
				*/

				betaValue = event.beta

				/*
					Gamma: represents the motion of the device around the y axis.
					Represented in degrees with values ranging from -90 to 90.
					This represents a left to right motion of the device.
				*/

				gammaValue = event.gamma

				setNode('alpha-client', alphaValue)
				setNode('beta-client', betaValue)
				setNode('gamma-client', gammaValue)

				if (connected && alphaValue && betaValue && gammaValue) {
					sendToServer('orientation', {
						alpha: alphaValue,
						beta: betaValue,
						gamma: gammaValue,
					})
				}
			}

			/**
			 * Client and server time, mainly for debug purposes
			 */

			document
				.querySelectorAll('h2.time, #client-time, #server-time')
				.forEach(node => (node.style.display = 'none'))

			if (DEBUG_TIME) {
				document
					.querySelectorAll('h2.time, #client-time, #server-time')
					.forEach(node => (node.style.display = 'block'))

				setInterval(() => {
					setNode('time-client', getClientTime(new Date()))
				}, 1)
			} else document.querySelectorAll('.time').forEach(node => node.classList.add('hide'))

			/**
			 * Handle device orientation
			 */

			// request permission for iOS 13+ ? NOT WORKING
			if (
				window.DeviceOrientationEvent !== undefined &&
				typeof window.DeviceOrientationEvent.requestPermission === 'function'
			) {
				window.DeviceOrientationEvent.requestPermission()
					.then(response => {
						if (response == 'granted') {
							window.addEventListener('deviceorientation', handleOrientation, true)
						}
					})
					.catch(error => {
						console.error('Unable to use DeviceOrientation API:', error)
					})
			} else {
				window.addEventListener('deviceorientation', handleOrientation, true)
			}

			/**
			 * Websockets communication
			 */

			WEBSOCKET.onopen = event => {
				connected = true
			}

			WEBSOCKET.onmessage = event => {
				let data
				let message

				if (typeof event.data.text === 'function') {
					console.log(event.data.text())
				} else {
					data = JSON.parse(event.data)
					message = JSON.parse(data.message)

					switch (data.type) {
						case 'time':
							if (DEBUG_TIME) setNode('time-server', message.time)
							break
						case 'orientation':
							setNode('alpha-server', message.alpha)
							setNode('beta-server', message.beta)
							setNode('gamma-server', message.gamma)
							break
						case 'notif':
							alert(message.soundName)

						default:
							break
					}
				}
			}
		</script>
	</body>
</html>
