<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Home sweet Home - Websockets Server</title>
		<style>
			p.small {
				font-size: 0.8rem;
			}
			p.bold {
				font-weight: bold;
			}
			.dialog {
				width: 50px;
			}
			.dialog .content {
				display: none;
				width: 100vw;
			}
			.dialog:hover .content {
				display: block;
			}
		</style>
	</head>

	<body>
		<h2 class="bold">Client time :</h2>

		<div id="client-time">waiting for javascript</div>

		<h2 class="bold">Server time :</h2>

		<div id="server-time">waiting for connection</div>

		<h2 class="bold">
			<span>Device Beta:</span>
			<span class="dialog">
				<button>?</button>
				<div class="content">
					<p class="small">
						Represents the front to back motion of the device, around the x axis. <br />
						In degrees with values ranging from -180 to 180. <br />
					</p>

					<p class="small bold">
						Only works on devices emitting the "deviceorientation" event, like smartphones.
					</p>
				</div>
			</span>
		</h2>

		<div id="device-beta">waiting for device event</div>

		<h2>Server Beta:</h2>

		<div id="server-beta">waiting for connection</div>

		<script>
			/* ------------------------------------------- */
			/* Vars : */
			/* ------------------------------------------- */

			const HOST = location.origin.replace(/^http/, 'ws');
			const ws = new WebSocket(HOST);

			let betaValue = 0;
			let connected = false;

			/* ------------------------------------------- */
			/* Functions : */
			/* ------------------------------------------- */

			const getClientTime = now => {
				const hours = now.getHours();
				const minutes = now.getMinutes();
				const seconds = now.getSeconds();
				const milliseconds = now.getMilliseconds();

				const dateString = `${hours}:${minutes}:${seconds}:${milliseconds}`;

				return dateString;
			};

			const setNode = (origin, value) => {
				let node;
				switch (origin) {
					case 'time-client':
						node = document.querySelector('#client-time');
						if (node) node.innerText = value;
						break;

					case 'time-server':
						node = document.querySelector('#server-time');
						if (node) node.innerText = value;
						break;

					case 'beta-client':
						node = document.querySelector('#device-beta');
						if (node) node.innerHTML = value;
						break;

					case 'beta-server':
						console.log(value);
						node = document.querySelector('#server-beta');
						if (node) node.innerHTML = value;
						break;

					default:
						break;
				}
			};

			const sendBetaValue = value => {
				// console.log(value);
				const message = { type: 'beta', message: value.toString() };
				const string = JSON.stringify(message);
				ws.send(string);
			};

			const handleOrientation = event => {
				/*
					Absolute: is true if the orientation data in instanceOfDeviceOrientationEvent is provided as the difference between the Earth's coordinate frame and the device's coordinate frame, or false if the orientation data is being provided in reference to some arbitrary, device-determined coordinate frame.
				*/

				/*
					Alpha: represents the motion of the device around the z axis.
					Represented in degrees with values ranging from 0 to 360.
				*/

				/*
					Beta: represents the motion of the device around the x axis.
					Represented in degrees with values ranging from -180 to 180.
					This represents a front to back motion of the device.
				*/

				/*
					Gamma: represents the motion of the device around the y axis.
					Represented in degrees with values ranging from -90 to 90.
					This represents a left to right motion of the device.
				*/
				betaValue = event.beta;
				setNode('beta-client', betaValue);
				if (connected) sendBetaValue(betaValue);
			};

			/* ------------------------------------------- */
			/* Logic : */
			/* ------------------------------------------- */

			/**
			 * Set client Time
			 */

			setInterval(() => {
				setNode('time-client', getClientTime(new Date()));
			}, 1);

			/**
			 * Handle device orientation
			 */

			window.addEventListener('deviceorientation', handleOrientation, true);

			/**
			 * Handle Websockets
			 */

			ws.onopen = event => {
				connected = true;
			};

			ws.onmessage = event => {
				const data = JSON.parse(event.data);

				switch (data.type) {
					case 'time':
						setNode(data.message, 'time-server');
						break;
					case 'beta':
						setNode(data.message, 'beta-server');
						break;

					default:
						break;
				}
			};
		</script>
	</body>
</html>
